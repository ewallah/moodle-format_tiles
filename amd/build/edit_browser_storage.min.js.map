{"version":3,"sources":["../src/edit_browser_storage.js"],"names":["define","$","storageSetUp","Selector","PAGE","EDITING_COLLAPSE_SECID","EDITING_COLLAPSE_SEC","EDITING_EXPAND_SEC","EDITING_EXPAND_SECID","SECTION_CONTENT","SECTION_MAIN","SECTION_ID","courseId","userId","StorageKeys","COURSE_VISIT","EDITING_COURSE","SECTION","COURSE","LAST_SECTION","USER","PREFIX","USER_CHOICE_PREFIX","CONTENT_SUFFIX","LAST_UPDATED_SUFFIX","StorageValues","OPEN","CLOSED","lastInteractedSection","encodeSectionStatus","sectionNum","getOpenSections","maxSection","sections","value","secNum","sessionStorage","getItem","push","lastSectionStorageKey","setLastSection","localStorage","clear","storageAllowed","setItem","toString","getLastSection","setSectionStatus","open","removeItem","clearStoredContent","Object","keys","filter","key","indexOf","length","forEach","item","clearStorage","init","userIdInit","courseIdInit","maxContentSectionsToStore","storedContentDeleteMins","assumeDataStoreConsent","lastSectionNum","collapsingAllFromURL","document","ready","Date","now","i","on","e","currTar","currentTarget","sectionClicked","closest","attr"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript Module to handle browser storage for editing interface.\n *\n * @module edit_browser_storage\n * @package course/format\n * @subpackage tiles\n * @copyright 2019 David Watson {@link http://evolutioncode.uk}\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since Moodle 3.3\n */\n\n/* eslint space-before-function-paren: 0 */\n\ndefine([\"jquery\", \"format_tiles/browser_storage_set_up\"], function ($, storageSetUp) {\n    \"use strict\";\n    var Selector = {\n        PAGE: '#page',\n        EDITING_COLLAPSE_SECID: \"#collapse\",\n        EDITING_COLLAPSE_SEC: \".collapse-section\",\n        EDITING_EXPAND_SEC: \".expand-section\",\n        EDITING_EXPAND_SECID: \"#expand\",\n        SECTION_CONTENT: \"li.section.main .content\",\n        SECTION_MAIN: \"li.section.main\",\n        SECTION_ID: \"#section-\"\n    };\n\n    var courseId;\n    var userId;\n\n    var StorageKeys = {\n        COURSE_VISIT: \"mdl-tiles-editing-last-visit-course-\",\n        EDITING_COURSE: \"mdl-tiles-editing-course-\",\n        SECTION: \"-section-\",\n        COURSE: \"mdl-tiles-course-\",\n        LAST_SECTION: \"-lastSecId\",\n        USER: \"-user-\",\n        PREFIX: \"mdl-tiles-\",\n        USER_CHOICE_PREFIX: \"mdl-tiles-userPrefStorage-\",\n        CONTENT_SUFFIX: \"-content\",\n        LAST_UPDATED_SUFFIX: \"-lastUpdated\"\n    };\n\n    var StorageValues = {\n        OPEN: \"1\",\n        CLOSED: \"0\"\n    };\n\n    var lastInteractedSection;\n\n    var encodeSectionStatus = function(sectionNum) {\n        return StorageKeys.EDITING_COURSE + courseId + StorageKeys.SECTION + sectionNum + StorageKeys.USER + userId;\n    };\n\n    /**\n     * Find out which sections of this course the user has showing as open in their browser storage.\n     * @param {number} maxSection\n     * @returns {Array}\n     */\n    var getOpenSections = function(maxSection) {\n        if (!maxSection || maxSection > 50) {\n            maxSection = 50; // Do not check more than 50 sections.\n        }\n        var sections = [];\n        var value;\n        for (var secNum = 1; secNum <= maxSection; secNum++) {\n            value = sessionStorage.getItem(encodeSectionStatus(secNum));\n            if (value === StorageValues.OPEN) {\n                sections.push(secNum);\n            }\n        }\n        return sections;\n    };\n\n    /**\n     * Storage key for the last section user was using.\n     * This is the same key as when not editing.\n     * @returns {string}\n     */\n    var lastSectionStorageKey = function () {\n        return StorageKeys.COURSE + courseId +\n        StorageKeys.USER + userId + StorageKeys.LAST_SECTION;\n    };\n\n    /**\n     * Set the last section the user was using.  This is the same key as when not editing.\n     * @param {number} sectionNum\n     */\n    var setLastSection = function(sectionNum) {\n        if (!sectionNum) {\n            localStorage.clear(lastSectionStorageKey());\n        } else if (sectionNum !== lastInteractedSection && storageSetUp.storageAllowed) {\n            lastInteractedSection = sectionNum;\n            localStorage.setItem(lastSectionStorageKey(), sectionNum.toString());\n        }\n    };\n\n    var getLastSection = function() {\n        if (!lastInteractedSection) {\n            lastInteractedSection = localStorage.getItem(lastSectionStorageKey());\n        }\n         return lastInteractedSection;\n    };\n\n    var setSectionStatus = function(secNum, open) {\n        if (storageSetUp.storageAllowed && open) {\n            sessionStorage.setItem(encodeSectionStatus(secNum), StorageValues.OPEN);\n        } else {\n            sessionStorage.removeItem(encodeSectionStatus(secNum));\n        }\n    };\n\n    /**\n     * If we are editing, we want to clear all stored content on initial page load.\n     * This ensure that, when we go back to not editing, our new content is shown not the old.\n     */\n    var clearStoredContent = function() {\n        Object.keys(sessionStorage).filter(function (key) {\n            return key.indexOf(StorageKeys.PREFIX) === 0 &&\n                (key.indexOf(StorageKeys.CONTENT_SUFFIX) === key.length - StorageKeys.CONTENT_SUFFIX.length\n                    || key.indexOf(StorageKeys.LAST_UPDATED_SUFFIX) === key.length - StorageKeys.LAST_UPDATED_SUFFIX.length);\n        }).forEach(function (item) {\n            // Item does relate to this plugin.\n            // It is not the user's preference about whether to use storage or not (keep that).\n            sessionStorage.removeItem(item);\n        });\n    };\n\n    /**\n     * Clear all browser storage used by this plugin.\n     */\n    var clearStorage = function() {\n        Object.keys(localStorage).filter(function (key) {\n            return key.indexOf(StorageKeys.PREFIX) === 0 && key.indexOf(StorageKeys.USER_CHOICE_PREFIX) === -1;\n        }).forEach(function (item) {\n            // Item does relate to this plugin.\n            // It is not the user's preference about whether to use storage or not (keep that).\n            localStorage.removeItem(item);\n        });\n        Object.keys(sessionStorage).filter(function (key) {\n            return key.indexOf(StorageKeys.PREFIX) === 0 && key.indexOf(StorageKeys.USER_CHOICE_PREFIX) === -1;\n        }).forEach(function (item) {\n            // Item does relate to this plugin.\n            // It is not the user's preference about whether to use storage or not (keep that).\n            sessionStorage.removeItem(item);\n        });\n    };\n\n    return {\n        getOpenSections: function(maxSection) {\n            return getOpenSections(maxSection);\n        },\n        init: function(\n            userIdInit,\n            courseIdInit,\n            maxContentSectionsToStore,\n            storedContentDeleteMins,\n            assumeDataStoreConsent,\n            lastSectionNum,\n            collapsingAllFromURL\n        ) {\n            courseId = courseIdInit;\n            userId = userIdInit;\n            if (lastSectionNum) {\n                setSectionStatus(lastSectionNum, true);\n            }\n            $(document).ready(function () {\n                storageSetUp.init(userId, assumeDataStoreConsent, clearStorage);\n                clearStoredContent();\n                if (storageSetUp.storageAllowed()) {\n                    sessionStorage.setItem(StorageKeys.COURSE_VISIT + courseId + StorageKeys.USER + userId, Date.now().toString());\n\n                    if (collapsingAllFromURL) {\n                        for (var i = 1; i <= lastSectionNum; i++) {\n                            setSectionStatus(i, false);\n                        }\n                    }\n                    // When section content is clicked, update the last visited section.\n                    $(Selector.PAGE).on(\"click\", Selector.SECTION_CONTENT, function(e) {\n                        var currTar = $(e.currentTarget);\n                        var sectionClicked = currTar.closest(Selector.SECTION_MAIN).attr(\"data-section\");\n                        setLastSection(sectionClicked);\n                    });\n                }\n            });\n        },\n        getLastSection: function() {\n            return getLastSection();\n        },\n        setSectionStatus: function(secNum, open) {\n            return setSectionStatus(secNum, open);\n        },\n        setLastSection: function(secNum) {\n            return setLastSection(secNum);\n        }\n    };\n});"],"file":"edit_browser_storage.min.js"}